#!/bin/bash

source @abs_srcdir@/config.rc

export CC=gcc
export CFLAGS="-g -fno-stack-protector"

export LD=g++
export LDFLAGS="-L$OPENCL_LIB_PATH -lOpenCL -L$OPENACC_LIB_PATH -lopenacc -L$SQLITE_LIB_PATH -lsqlite3 -lrt"

$CC $CFLAGS -L$SQLITE_LIB_PATH -lsqlite3 db-tools/init_db.c -o db-tools/init_db
$CC $CFLAGS -L$SQLITE_LIB_PATH -lsqlite3 db-tools/init_min_db.c -o db-tools/init_min_db

$CC $CFLAGS -I$OPENACC_INC_PATH -I$OPENCL_INC_PATH -I$SQLITE_INC_PATH -c eval-100.c -o eval-100.o
$CC $CFLAGS -I$OPENACC_INC_PATH -I$OPENCL_INC_PATH -I$SQLITE_INC_PATH -c eval-min.c -o eval-min.o

for test in $TEST
do
  cd $test

  $CC $CFLAGS -I$OPENACC_INC_PATH -I$OPENCL_INC_PATH -c @abs_top_srcdir@/tests/$test/init.c -o init.o
  $CC $CFLAGS -I$OPENACC_INC_PATH -I$OPENCL_INC_PATH -c @abs_top_srcdir@/tests/$test/kernel-libopenacc.c -o kernel-libopenacc.o

  for t0 in $TILE_0
  do
    for t1 in $TILE_1
    do
      for t2 in $TILE_2
      do
        if isValidTiling $t0 $t1 $t2
        then
          cd $t0-$t1-$t2

          export ENV_HOST_DATA="-DKERNEL_DIR=\"`pwd`\" -DLIBOPENACC_DIR=\"@abs_top_srcdir@/libopenacc\""

          $CC $CFLAGS -I$OPENACC_INC_PATH -I$OPENCL_INC_PATH $ENV_HOST_DATA -c host-data.c -o host-data.o

          $LD $LDFLAGS ../../eval-100.o ../init.o ../kernel-libopenacc.o host-data.o -o eval
          $LD $LDFLAGS ../../eval-min.o ../init.o ../kernel-libopenacc.o host-data.o -o eval-min

          cd ..
        fi
      done
    done
  done
  cd ..
done

