#!/bin/bash

source @abs_srcdir@/config.rc

isValidTiling() {
  if [ "$1" -gt 0 ] && [ "$2" -gt 0 ] && [ "$3" -eq 0 ]
  then
    return 0;
  elif [ "$1" -gt 0 ] && [ "$2" -eq 0 ] && [ "$3" -gt 0 ]
  then
    return 0;
  elif [ "$1" -eq 0 ] && [ "$2" -gt 0 ] && [ "$3" -gt 0 ]
  then
    return 0;
  else
    return 1;
  fi
}

for test in $TEST
do
  rm -rf $test
  mkdir -p $test

  cd $test
  for t0 in $TILE_0
  do
    for t1 in $TILE_1
    do
      for t2 in $TILE_2
      do
        if isValidTiling $t0 $t1 $t2
        then
          mkdir -p $t0-$t1-$t2
          cd $t0-$t1-$t2

          $COMPILER @abs_top_srcdir@/tests/$test/klt.lt @abs_top_srcdir@/libopenacc/include/ /usr/include/ $t0 $t1 $t2

          echo >> host-data.c
          echo "unsigned tiles[4] = {$t0, $t1, $t2, 1};" >> host-data.c
          echo "unsigned test_id = $test;" >> host-data.c
          echo >> host-data.c

          cd ..
        fi
      done
    done
  done
  cd ..
done

