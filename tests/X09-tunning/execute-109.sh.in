#!/bin/bash

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:@abs_top_srcdir@/libopenacc/lib

echo
echo "*************"
echo "* Execution *"
echo "*************"
echo

# Check that versions data-base is accessible 
if [ ! -r $1 ]
then
  echo "Cannot read versions data-base."
  exit 3
fi

# Look for the last versions previously executed
if [ -r $2 ]
then
  last_executed_version=`sqlite3 $1 "select max(version_id) from Runs;"`
  if [ ! -z $last_executed_version ]
  then
    # Remove emtry for the last executed version (might have not executed all configuration)
    run_ids=`sqlite3 $1 "Select rowid from Runs where version_id='$last_executed_version';"`
    for run in $run_ids
    do
      sqlite3 $1 "Delete from Events where run_id='$run';"
    done
    sqlite3 $1 "Delete from Runs where version_id='$last_executed_version';"
  else
    last_executed_version=0
  fi
else
  last_executed_version=0
fi

# Load device type and ranges for n/m/p and gang/worker
source $3

for version_id in `sqlite3 $1 "select version_id from Versions where region_id=='0' and kernel_id=='0' and version_id >= '$last_executed_version';"`
do

  if [ $version_id -lt $last_executed_version ]
  then
    echo "Skip version #$version_id"
    continue
  else
    echo "Execute version #$version_id"
  fi

  ACC_PROFILING_DB=$2 ACC_DEVICE_TYPE=$device_type ./test-109  $n_exp_min $n_exp_max $m_exp_min $m_exp_max $p_exp_min $p_exp_max $gang_exp_min $gang_exp_max $worker_exp_min $worker_exp_max $version_id

done

